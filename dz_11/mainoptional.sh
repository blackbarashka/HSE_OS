#!/bin/bash

# Скрипт для определения максимальной глубины рекурсии символических ссылок

# Удаляем предыдущую тестовую директорию если она существует
TEST_DIR="symlink_test_dir"
rm -rf "$TEST_DIR"

# Создаем директорию для тестов
mkdir -p "$TEST_DIR"

# Создаем базовый файл
BASE_FILE="$TEST_DIR/a"
echo "test content" > "$BASE_FILE"

echo "Базовый файл создан: $BASE_FILE"

# Первая ссылка указывает на файл 'a' (относительный путь)
ln -s "a" "$TEST_DIR/link_0" || {
    echo "Ошибка создания первой символической ссылки: $?"
    exit 1
}

# Проверяем первую ссылку
if ! cat "$TEST_DIR/link_0" > /dev/null 2>&1; then
    echo "Не удалось открыть первую ссылку"
    exit 1
fi

DEPTH=1
MAX_ATTEMPTS=100  # Ограничение на максимальное число попыток

for ((i=1; i<MAX_ATTEMPTS; i++)); do
    # Создаем новую символическую ссылку на предыдущую (используем относительный путь)
    PREV_LINK="link_$((i-1))"
    CURR_LINK="$TEST_DIR/link_$i"
    
    ln -s "$PREV_LINK" "$CURR_LINK" || {
        echo "Не удалось создать ссылку глубиной $((i+1)): $?"
        break
    }
    
    # Пытаемся прочитать содержимое через символическую ссылку
    if ! cat "$CURR_LINK" > /dev/null 2>&1; then
        echo "Не удалось открыть ссылку глубиной $((i+1))"
        break
    fi
    
    DEPTH=$((i+1))
done

echo "Максимальная глубина рекурсии символических ссылок: $DEPTH"
echo "Примечание: Все тестовые файлы созданы в директории $TEST_DIR"
echo "Для удаления директории выполните команду: rm -rf $TEST_DIR"

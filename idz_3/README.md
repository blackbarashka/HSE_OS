# Отчет по лабораторной работе №3  
## "Клиент-серверное приложение: Поиск Винни-Пуха"

**Выполнил:** Мусаев Умахан Рашидович, БПИ234 
**Вариант:** 4  

---

## Условие:

Задача о Винни-Пухе – 3 или мстительные пчелы. Неправильные пчелы, подсчитав в конце месяца убытки от наличия в
лесу Винни-Пуха, решили разыскать его и наказать в назидание
всем другим любителям сладкого. Для поисков медведя они поделили лес на участки, каждый из которых прочесывает одна стая
неправильных пчел. В случае нахождения медведя на своем участке стая проводит показательное наказание и возвращается в улей.
Если участок прочесан, а Винни-Пух на нем не обнаружен, стая также возвращается в улей. Там она получает информацию об еще
участках, которые еще не исследованы и снова улетает. Или прекращает поиски, узнав, что Винни-Пух наказан.
Создать клиент–серверное приложение, моделирующее поведение пчел.
Каждая стая — отдельный клиент, взаимодействующий с сервером. Сервер обрабатывает поступающие сообщения и передает
их клиентам в соответствии с установленными выше правилами.




---

## 4–5 баллов: Базовое клиент-серверное приложение

### Структура и методы

**Сервер:**
- Инициализация массива участков леса, случайное размещение Винни-Пуха.
- Ожидание TCP-подключений от клиентов.
- Для каждого клиента:
  - Принимает запрос на участок (`REQUEST_AREA:<id>`).
  - Назначает нераспределённый участок (`AREA:<номер>`).
  - Получает результат поиска (`SEARCH:<номер>`), обновляет статус участка.
  - Сообщает клиенту результат (`FOUND`/`NOTFOUND`).
- Методы:
  - `main()`: основной цикл, обработка подключений.
  - `assignArea()`: выбор и назначение участка.
  - `processSearchResult()`: обработка результата поиска.

**Клиент:**
- Подключается к серверу, запрашивает участок.
- Имитация поиска (задержка).
- Отправка результата поиска.
- Получение нового задания или завершение работы.
- Методы:
  - `main()`: цикл поиска.
  - `requestArea()`: запрос участка.
  - `searchArea()`: имитация поиска.
  - `sendResult()`: отправка результата.

**Модификации:**  
- Использование аргументов командной строки для IP и порта.
- Возможность запуска на разных компьютерах.
- Каждый компонент отображает только свою локальную информацию.

### Запуск:
1. `make`  или `g++ -o server server.cpp`,`g++ -o client client.cpp`
2. `./server 127.0.0.1 8080` в 1 терминале
3.1 `./client <id стаи> 127.0.0.1 8080` в 2 терминале (запуск одной стаи)
   Пример:
   
   ![image](https://github.com/user-attachments/assets/8f38d7d3-9717-4608-ad51-7a3fefb9c6dc)
3.2 `./run_bees.sh <количество стай, например 5> 127.0.0.1 8080` в 2 терминале (запуск сразу нескольких стай)
   Пример:
   
   ![image](https://github.com/user-attachments/assets/8f9a45c6-73b6-4198-9d00-76e550e61643)
Пчелы успешно находят Винни-Пуха и возвращаются в улей.

---

## 6–7 баллов: Добавление клиента-наблюдателя

### Новые компоненты и методы

**Сервер:**
- Ведение журнала событий (назначения, результаты поиска).
- Обработка подключения наблюдателя (`OBSERVER`).
- Передача истории событий и новых событий наблюдателю.
- Методы:
  - `addLogEntry()`: добавление события в журнал и рассылка наблюдателям.
  - `handleObserver()`: поток для обслуживания наблюдателя.

**Наблюдатель(`observer.cpp`):**
- Подключается к серверу, получает историю и новые события.
- Отображает комплексную картину поиска.
- Методы:
  - `main()`: подключение и цикл приёма событий.
  - `printFormattedMessage()`: форматированный вывод событий.

**Модификации:**
- Сервер теперь поддерживает два типа клиентов: обычные и наблюдатели.
- Введён журнал событий и механизм рассылки.

### Запуск:
1. `make`  или `g++ -o server server.cpp`,`g++ -o client client.cpp`,`g++ -o observer observer.cpp`
2. `./server 127.0.0.1 8080` в 1 терминале
3. `./observer 127.0.0.1 8080` в 2 терминале
4.1 `./client <id стаи> 127.0.0.1 8080` в 3 терминале (запуск одной стаи)
   Пример:
   
   ![image](https://github.com/user-attachments/assets/e836442d-9a47-4d91-9243-e5f40174aeea)
4.2 `./start_bees.sh <количество стай, например 5> 127.0.0.1 8080` в 3 терминале (запуск сразу нескольких стай)
  Пример:

  ![image](https://github.com/user-attachments/assets/d60ebd04-1763-48c6-8faf-b6bfc9ca0fb4)

---

## 8 баллов: Множественные наблюдатели

### Расширения и методы

**Сервер:**
- Поддержка списка наблюдателей.
- Многопоточная обработка подключений наблюдателей.
- Синхронизация доступа к журналу и списку наблюдателей (`std::mutex`).
- Методы:
  - `observers` (список), `logMutex`, `observersMutex` (мьютексы).
  - `handleObserver()` теперь работает в отдельном потоке для каждого наблюдателя.

**Наблюдатель:**
- Возможность запуска нескольких наблюдателей одновременно.
- Получение полной истории событий при подключении.
- Цветное форматирование вывода, статистика поиска.
- Методы:
  - `SearchStats`: структура для сбора статистики.
  - `update()`, `display()`: обновление и вывод статистики.

**Модификации:**
- Динамическое подключение/отключение наблюдателей без остановки системы.
- Улучшенная визуализация и информативность.

### Запуск:
1. `make`  или `g++ -o server server.cpp`,`g++ -o client client.cpp`,`g++ -o observer observer.cpp`
2. `./server 127.0.0.1 8080` в 1 терминале
3. `./observer 127.0.0.1 8080` в 2 терминале
4.1 `./client <id стаи> 127.0.0.1 8080` в 3 терминале (запуск одной стаи)
   Пример c двумя наблюдателями:
   
  ![image](https://github.com/user-attachments/assets/63474b72-621f-49ef-8e35-99309f6f288a)

4.2 `./run_clients.sh <количество стай, например 5> 127.0.0.1 8080` в 3 терминале (запуск сразу нескольких стай)
  Пример c двумя наблюдателями:

  ![image](https://github.com/user-attachments/assets/23d2f40e-424e-4f26-941a-7f0eb039a121)

---

## 9-10 баллов: Динамическое управление клиентами и корректное завершение всех процессов

###Завершение работы сервера и всех компонентов, кроме менеджера - `Ctrl+C`
### Новые компоненты и методы

**Менеджер стай (bee_manager):**
- Интерактивное меню для запуска/остановки стай.
- Отслеживание PID и статуса каждой стаи.
- Методы:
  - `startBeeSwarm()`: запуск новой стаи через fork/exec.
  - `stopBeeSwarm()`: остановка стаи через сигнал.
  - `listActiveSwarms()`: вывод активных стай.
  - `checkServerStatus()`: проверка доступности сервера.
  - `displayMenu()`: цветное меню.

**Сервер:**
- Реестр стай (`SwarmInfo`), отслеживание активности и таймаутов.
- Автоматическое освобождение участков при неактивности или отключении стаи.
- Методы:
  - `monitorInactiveSwarms()`: отдельный поток для контроля активности.
  - Обработка команды `DISCONNECT:<id>`.
- Обработка сигналов завершения (`SIGINT`, `SIGTERM`).
- Отправка специального сообщения `SHUTDOWN` всем активным клиентам и наблюдателям.
- Ожидание завершения всех соединений перед выходом.
- Методы:
  - `signalHandler()`: обработка сигнала завершения.
  - Хранение списка активных сокетов, рассылка `SHUTDOWN`.

**Клиент:**
- Обработка сигналов завершения (`SIGINT`).
- Уведомление сервера об отключении.
- Повторные попытки подключения при ошибках.
- Обработка сообщения `SHUTDOWN` от сервера.
- Корректное завершение работы, освобождение ресурсов.
- Методы:
  - Проверка ответа сервера на наличие `SHUTDOWN`.
  - Завершение основного цикла и закрытие соединения.
**Наблюдатель:**
- Аналогичная обработка сообщения `SHUTDOWN`.
- Завершение работы по сигналу от сервера.

**Менеджер стай:**
- Цветной интерфейс.
- Корректное завершение всех стай при остановке сервера.
  
**Модификации:**
- Возможность динамического запуска/остановки клиентов без перезапуска сервера.
- Повышенная отказоустойчивость.
- Гарантированное завершение всех процессов при остановке сервера.
- Исключение “зависших” клиентов и наблюдателей.
- Повышенная устойчивость к ошибкам и сбоям.

### Запуск:
1. `make`  или `g++ -o server server.cpp`,`g++ -o client client.cpp`,`g++ -o observer observer.cpp`, `g++ -o bee_manager bee_manager.cpp`
2. `make run-server` в 1 терминале
3. `make run-observer в 2 терминале
4. `make run-manager` в 3 терминале и в менеджере уже запускаем стаи
   Пример:
   
   ![image](https://github.com/user-attachments/assets/09943957-149e-4aa1-bfe7-2fbdfc88a89f)

##Меню менеджера:

![image](https://github.com/user-attachments/assets/87e29cc3-2321-4c3e-8484-73e709b1caa8)

##Корректное завершение работы программ:

![image](https://github.com/user-attachments/assets/8346026c-59a3-473f-8b4b-00c703cdeabc)
![image](https://github.com/user-attachments/assets/cc5098eb-1bea-4cdc-9fce-f84220ab80fa)



---

## Демонстрация и результаты

- Для каждого этапа работы можно использовать консольный вывод, логи, скриншоты или видео.
- В менеджере стай реализовано цветное меню для удобства пользователя.
- Все процессы корректно завершаются при остановке сервера, что подтверждается выводом в терминале.
- Программы могут быть запущены как на одном компьютере, так и в распределённой сети.

---

## Выводы

- Каждый этап работы расширяет функциональность предыдущего.
- Использованы системные вызовы ОС Linux, многопоточность, обработка сигналов, TCP-сокеты.

